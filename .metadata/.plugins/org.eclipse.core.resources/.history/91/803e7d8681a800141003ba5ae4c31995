package nl.uva.td.game;

import java.util.HashSet;
import java.util.Set;

import nl.uva.td.experiment.Score;
import nl.uva.td.game.map.GameField;
import nl.uva.td.game.tower.Tower;
import nl.uva.td.game.unit.Creep;
import nl.uva.td.game.unit.SimpleCreep;

public class GameManager {

    public Score run(final Agent agent, final GameField gameField) {
        int playerHealth = 10;
        int turnCouter = 0;
        Set<Creep> creeps = new HashSet<Creep>();
        Set<Tower> towers = new HashSet<Tower>();
        Set<Creep> killedCreep;

        SimpleCreep simpleCreep = new SimpleCreep();
        creeps.add(simpleCreep);
        gameField.getStartField().addCreep(simpleCreep);
        simpleCreep.setCurrentField(gameField.getStartField());

        /*
         * 1.Place 2.Shoot 3.Walk
         */
        while (playerHealth > 0) {

            // Shoot
            for (Tower tower : towers) {
                killedCreep = tower.shoot();

                if (killedCreep != null) {

                    for (Creep creep : killedCreep) {
                        creep.unregisterOfAllTowers();
                    }

                    creeps.remove(killedCreep);
                    killedCreep = null;
                }
            }

            // Walk
            for (Creep creep : creeps) {
                if (creep.move()) {
                    // creep went into the goal
                    playerHealth--;
                }
            }

            turnCouter++;
        }

        return new Score(++turnCouter);
    }
}